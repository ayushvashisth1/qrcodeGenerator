<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Stylesheet -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 container-bg">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full text-center border-4 border-gray-200">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">QR Code Generator</h1>
        <p class="text-sm text-gray-500 mb-6">Enter a URL below to create your QR code.</p>
        
        <div class="mb-6">
            <input type="url" id="urlInput" placeholder="https://www.example.com" class="w-full p-3 text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-300">
        </div>
        
        <div class="relative flex items-center justify-center h-48 mb-6 bg-gray-200 rounded-lg overflow-hidden">
            <!-- QR code image will be displayed here -->
            <img id="qrCodeImage" src="https://placehold.co/200x200/e0e0e0/ffffff?text=QR+Code" alt="QR Code" class="w-full h-full object-contain p-2">
            <!-- Loading spinner overlay -->
            <div id="loadingSpinner" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-80 transition-opacity duration-300 opacity-0 pointer-events-none">
                <div class="animate-spin rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-gray-200"></div>
            </div>
        </div>
        
        <button id="generateBtn" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-blue-300 mb-4">Generate QR Code</button>

        <a id="downloadBtn" href="#" download="qrcode.png" class="w-full block bg-gray-700 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-800 transition duration-300 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-gray-300 hidden">Download QR Code</a>

        <p id="errorMsg" class="text-red-500 text-sm mt-4 hidden">Please enter a valid URL.</p>
    </div>

    <script>
        // Get references to HTML elements
        const urlInput = document.getElementById('urlInput');
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const qrCodeImage = document.getElementById('qrCodeImage');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const errorMsg = document.getElementById('errorMsg');

        /**
         * Shows the loading spinner.
         */
        const showLoading = () => {
            loadingSpinner.classList.remove('opacity-0', 'pointer-events-none');
            loadingSpinner.classList.add('opacity-100');
        };

        /**
         * Hides the loading spinner.
         */
        const hideLoading = () => {
            loadingSpinner.classList.remove('opacity-100');
            loadingSpinner.classList.add('opacity-0', 'pointer-events-none');
        };

        /**
         * Handles the button click to generate and display the QR code.
         */
        const handleGenerate = async () => {
            // Get the URL from the input field and trim whitespace
            const url = urlInput.value.trim();

            // Clear any previous error messages
            errorMsg.classList.add('hidden');
            
            // Validate the URL
            if (!url) {
                errorMsg.textContent = 'Please enter a URL.';
                errorMsg.classList.remove('hidden');
                return;
            }

            // Simple URL validation
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                errorMsg.textContent = 'Please enter a valid URL (e.g., https://example.com).';
                errorMsg.classList.remove('hidden');
                return;
            }

            showLoading();
            generateBtn.disabled = true;
            downloadBtn.classList.add('hidden');

            try {
                // Make a POST request to the Python backend to generate the QR code
                const response = await fetch('/generate_qr', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: url })
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Update the image source with the base64 data received from the server
                qrCodeImage.src = `data:image/png;base64,${data.image}`;

                // Update the download link
                downloadBtn.href = `data:image/png;base64,${data.image}`;
                downloadBtn.classList.remove('hidden');
            } catch (error) {
                // Display a user-friendly error message if generation fails
                console.error('Error generating QR code:', error);
                errorMsg.textContent = 'Failed to generate QR code. Please try again later.';
                errorMsg.classList.remove('hidden');
            } finally {
                hideLoading();
                generateBtn.disabled = false;
            }
        };

        // Add an event listener to the button
        generateBtn.addEventListener('click', handleGenerate);

        // Allow pressing 'Enter' key to generate the QR code
        urlInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleGenerate();
            }
        });
    </script>
</body>
</html>
